#! /usr/bin/env bash

set -e

root=${1:-$PWD}

branch=$(git rev-parse --abbrev-ref HEAD)
if [ "${branch}" = "master" ]; then
  server=""
else
  server="--server=https://luarocks.org/dev"
fi

for dir in "${root}"/lua*; do
  if [ -d "${dir}" ]; then
    echo "Installing in ${dir}..."
    "${dir}/bin/luarocks" make rockspec/layeredata-env-master-1.rockspec
    "${dir}/bin/luarocks" make "${server}" rockspec/layeredata-master-1.rockspec
  fi
done

for dir in "${root}"/lua*; do
  if [ -d "${dir}" ]; then
    echo "Testing in ${dir}..."
    "${dir}/bin/luacheck" src/
    "${dir}/bin/busted"   src/layeredata/init_spec.lua
  fi
done

for dir in "${root}"/lua*; do
  if [ -d "${dir}" ]; then
    "${dir}/bin/luacov"
    sed -ne '/Summary/,$ p' luacov.report.out
    break
  fi
done
