#! /usr/bin/env bash

branch=$(git rev-parse --abbrev-ref HEAD)
if [ "${branch}" = "master" ]; then
  tag=$(git describe --tags --abbrev=0 || echo "0.0")
  count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
else
  tag="dev"
  count="1"
fi

cd rockspec || exit 1
sed -e "s/master-1/${tag}-${count}/" "layeredata-master-1.rockspec" \
  > "layeredata-${tag}-${count}.rockspec"
luarocks upload \
  --force \
  --api-key="${LUAROCKS_TOKEN}" \
  "layeredata-${tag}-${count}.rockspec"
cd ..
