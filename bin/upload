#! /usr/bin/env bash

branch=$(git rev-parse --abbrev-ref HEAD)
if [ "${branch}" = "master" ]; then
  server="http://luarocks.org/"
else
  server="http://luarocks.org/dev"
fi
tag=$(git describe --tags --abbrev=0 || echo "0.0")
count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)

cd rockspec || exit 1
rockspec=layeredata-master-1.rockspec
name=layeredata
sed -e "s/master-1/${tag}-${count}/" "${rockspec}" \
  > "${name}"-"${tag}"-"${count}".rockspec
luarocks upload \
  --server="${server}" \
  --api-key="${LUAROCKS_TOKEN}" \
  "${name}"-"${tag}"-"${count}".rockspec
cd ..
